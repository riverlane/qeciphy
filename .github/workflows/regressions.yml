name: CI Pipeline
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # Detect which files have changed to determine which jobs to run
  changes:
    runs-on: sanity-builder
    environment: ci
    outputs:
      lint: ${{ steps.changes.outputs.lint }}
      format: ${{ steps.changes.outputs.format }}
      simulation: ${{ steps.changes.outputs.simulation }}
      synthesis: ${{ steps.changes.outputs.synthesis }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            lint:
              - 'lint_stubs/**'
              - 'src/**'
              - 'src.f'
              - 'lint.f'
              - 'lib/**'
              - 'lint_waivers.vlt'
              - 'Makefile'
              - 'scripts/**'
              - 'config.json'
            format:
              - '**/*.sv'
              - '**/*.sva'
              - '**/*.svh'
              - '**/*.v'
            simulation:
              - 'src/**'
              - 'lib/**'
              - 'tb/**'
              - 'vendors/**'
              - 'sim.f'
              - 'src.f'
              - 'Makefile'
              - 'scripts/**'
              - 'config.json'
            synthesis:
              - 'src/**'
              - 'lib/**'
              - 'example_designs/**'
              - 'vendors/**'
              - 'src.f'
              - 'Makefile'
              - 'scripts/**'
              - 'config.json'

  # Static analysis jobs that must pass before expensive FPGA jobs
  static-checks:
    needs: changes
    if: needs.changes.outputs.lint == 'true' || needs.changes.outputs.format == 'true'
    runs-on: sanity-builder
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Check code formatting
        if: needs.changes.outputs.format == 'true'
        run: |
          bash ci/format.sh
      - name: Lint FPGA code
        if: needs.changes.outputs.lint == 'true'
        run: |
          bash ci/lint.sh

  fpga-simulation:
    needs: [changes, static-checks]
    if: |
      always() && 
      needs.changes.outputs.simulation == 'true' && 
      (needs.static-checks.result == 'success' || needs.static-checks.result == 'skipped')
    runs-on: sanity-builder
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Run simulations using XSIM
        run: |
          bash ci/xsim_sim.sh

  fpga-simulation-vcs:
    needs: [changes, static-checks]
    if: |
      always() && 
      needs.changes.outputs.simulation == 'true' && 
      (needs.static-checks.result == 'success' || needs.static-checks.result == 'skipped')
    runs-on: sanity-builder
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Run simulations using VCS
        run: |
          bash ci/vcs_sim.sh

  fpga-synthesis:
    needs: [changes, static-checks]
    if: |
      always() && 
      needs.changes.outputs.synthesis == 'true' && 
      (needs.static-checks.result == 'success' || needs.static-checks.result == 'skipped')
    runs-on: sanity-builder
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Run synthesis
        run: |
          bash ci/synth.sh
